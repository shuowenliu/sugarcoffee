<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>批次匯入歌曲</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    h2 { color: #333; }
    .log { background: #fff; padding: 10px; border: 1px solid #ccc; height: 300px; overflow-y: auto; white-space: pre-line; }
    input[type="file"] { margin-bottom: 10px; }
    button { padding: 8px 16px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>🎵 批次匯入歌曲</h2>
  <input type="file" id="fileInput" accept=".csv" />
  <button onclick="importCSV()">開始匯入</button>
  <div class="log" id="log"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzF2TiPXvC5Wc9Qka2mQ1H3SSGzxCV_LDFBK6YXN-GdxMKqFrpEWrC1kvhPK72JnZd1Jg/exec";

    function log(msg) {
      document.getElementById("log").innerText += msg + "\n";
    }

    async function importCSV() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("請先選擇 CSV 檔案！");
      
      const text = await file.text();
      const rows = text.split("\n").map(r => r.split(",").map(v => v.trim())).filter(r => r.length >= 4);
      
      log(`讀取到 ${rows.length - 1} 筆資料，開始匯入...\n`);
      for (let i = 1; i < rows.length; i++) { // 跳過表頭
        const [name, bpm, lang, style] = rows[i];
        if (!name) continue;

        const song = { id: "", name, bpm: parseInt(bpm) || 0, lang, style };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "saveSong", song })
          });
          const result = await res.json();

          if (result.status === "ok") {
            log(`✅ 新增成功：${name} (${lang}/${style})`);
          } else if (result.status === "duplicate") {
            log(`⚠️ 跳過重複：${name}`);
          } else {
            log(`❌ 失敗：${name} (${JSON.stringify(result)})`);
          }
        } catch (e) {
          log(`❌ 錯誤：${name} (${e.message})`);
        }
      }
      log("\n🎉 匯入完成！");
    }
  </script>
</body>
</html>
