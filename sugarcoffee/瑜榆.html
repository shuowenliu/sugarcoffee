<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ„›å¿ƒç¨®æ¤ç´€éŒ„</title>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #fdeff9, #ecf0f3);
      color: #444;
      text-align: center;
      padding: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #f5b5c0;
      padding: 12px;
      vertical-align: top;
      width: 50%;
    }
    .farm {
      background: #fff8f8;
      border-radius: 12px;
      padding: 20px;
    }
    .farm h2 {
      color: #e18aaa;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 1rem;
      border-radius: 12px;
      border: none;
      background-color: #f9c5d1;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:disabled {
      background-color: #ddd;
      cursor: not-allowed;
    }
    .status {
      margin-top: 10px;
      font-size: 1.1rem;
      color: #e18aaa;
    }
    .log {
      margin-top: 20px;
      text-align: left;
      font-size: 0.9rem;
    }
    @media (max-width: 768px) {
      table, tr, td {
        display: block;
        width: 100%;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>
  <h1>ğŸŒ¸ æ„›å¿ƒç¨®æ¤ç´€éŒ„ ğŸŒ¸</h1>
  <table>
    <tr>
      <td>
        <div class="farm" id="farm-yuyu">
          <h2>ç‘œæ¦†çš„æ„›å¿ƒè¾²å ´</h2>
          <div>
            <button class="plantSeed">ğŸŒ± ä¸‹ç¨®å­</button>
            <button class="water" disabled>ğŸ’§ æ¾†æ°´</button>
            <button class="dust" disabled>ğŸ§¼ é™¤å¡µ</button>
            <button class="clear">ğŸ—‘ æ¸…é™¤ç´€éŒ„</button>
          </div>
          <div class="status"></div>
          <div class="log"></div>
        </div>
      </td>
      <td>
        <div class="farm" id="farm-coffee">
          <h2>å’–å•¡æ£ çš„æ„›å¿ƒè¾²å ´</h2>
          <div>
            <button class="plantSeed">ğŸŒ± ä¸‹ç¨®å­</button>
            <button class="water" disabled>ğŸ’§ æ¾†æ°´</button>
            <button class="dust" disabled>ğŸ§¼ é™¤å¡µ</button>
            <button class="clear">ğŸ—‘ æ¸…é™¤ç´€éŒ„</button>
          </div>
          <div class="status"></div>
          <div class="log"></div>
        </div>
      </td>
    </tr>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5VJ1cb_ihQSlfzQm8vLa-0exU5-YTrc0",
      authDomain: "coffeesugar-planting.firebaseapp.com",
      projectId: "coffeesugar-planting",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const stageLimits = [1, 1, 5, 9];

    function setupFarm(farmId, docId) {
      const container = document.getElementById(farmId);
      const plantSeed = container.querySelector('.plantSeed');
      const water = container.querySelector('.water');
      const dust = container.querySelector('.dust');
      const clear = container.querySelector('.clear');
      const status = container.querySelector('.status');
      const logDiv = container.querySelector('.log');

      let state = {
        seeded: false,
        stage: 0,
        progress: 0,
        log: [],
        nextAction: 'water'
      };

      const recordRef = db.collection('heart_planting').doc(docId);

      function updateUI() {
        plantSeed.disabled = state.seeded;
        water.disabled = !(state.seeded && state.nextAction === 'water');
        dust.disabled = !(state.seeded && state.nextAction === 'dust');

        if (!state.seeded) {
          status.innerText = 'è«‹å…ˆä¸‹ç¨®å­';
        } else {
          status.innerText = `ç›®å‰ç‚ºç¬¬ ${state.stage + 1} éšæ®µï¼Œç¬¬ ${Math.floor(state.progress / 2) + 1} æ¬¡ ${state.nextAction === 'water' ? 'æ¾†æ°´' : 'é™¤å¡µ'}`;
        }

        logDiv.innerHTML = '<h3>ç´€éŒ„ï¼š</h3>' + (state.log.length ? state.log.map(e => `ã€${e.action}ã€‘ç¬¬${e.stage + 1}éšæ®µï¼Œç¬¬${e.count}æ¬¡ - ${e.time}`).reverse().join('<br>') : 'ç„¡');
      }

      function logAction(action) {
        const now = new Date().toLocaleString();
        const entry = {
          action,
          stage: state.stage,
          count: Math.floor(state.progress / 2) + 1,
          time: now
        };
        state.log.push(entry);
      }

      async function saveState() {
        await recordRef.set(state);
      }

      plantSeed.onclick = async () => {
        if (state.seeded) return;
        state = {
          seeded: true,
          stage: 0,
          progress: 0,
          log: [],
          nextAction: 'water'
        };
        logAction('ä¸‹ç¨®å­');
        await saveState();
        updateUI();
      };

      water.onclick = async () => {
        if (!state.seeded || state.nextAction !== 'water') return;
        logAction('æ¾†æ°´');
        state.progress++;
        state.nextAction = 'dust';
        await checkProgress();
      };

      dust.onclick = async () => {
        if (!state.seeded || state.nextAction !== 'dust') return;
        logAction('é™¤å¡µ');
        state.progress++;
        state.nextAction = 'water';
        await checkProgress();
      };

      async function checkProgress() {
        const limit = stageLimits[state.stage] * 2;
        if (state.progress >= limit) {
          if (state.stage < stageLimits.length - 1) {
            state.stage++;
            state.progress = 0;
          } else {
            state.nextAction = 'done';
            water.disabled = true;
            dust.disabled = true;
          }
        }
        await saveState();
        updateUI();
      }

      clear.onclick = async () => {
        await recordRef.delete();
        state = {
          seeded: false,
          stage: 0,
          progress: 0,
          log: [],
          nextAction: 'water'
        };
        updateUI();
      };

      async function init() {
        const doc = await recordRef.get();
        if (doc.exists) state = doc.data();
        updateUI();
      }

      init();
    }

    setupFarm('farm-yuyu', 'record_yuyu');
    setupFarm('farm-coffee', 'record_coffee');
  </script>
</body>

</html>
