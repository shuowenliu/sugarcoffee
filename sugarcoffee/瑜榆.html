<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ„›å¿ƒç¨®æ¤ç´€éŒ„</title>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #fdeff9, #ecf0f3);
      padding: 30px;
      text-align: center;
    }
    table.layout { width: 100%; border-collapse: collapse; }
    table.layout td { vertical-align: top; width: 50%; padding: 10px; }
    .farm {
      background: #fff8f8;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 8px #f3c4ce;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      background: #f9c5d1;
      cursor: pointer;
    }
    button:disabled { background-color: #ddd; cursor: not-allowed; }
    .log table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    $1
  white-space: nowrap;
  word-break: keep-all;
  max-width: 1px;
    .status { color: #e18aaa; margin: 10px 0; }
    @media (max-width: 768px) {
      table.layout, table.layout td { display: block; width: 100%; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>
  <h1>ğŸŒ¸ æ„›å¿ƒç¨®æ¤ç´€éŒ„ ğŸŒ¸</h1>
  <table class="layout">
    <tr>
      <td><div class="farm" id="farm-yuyu"><h2>ç‘œæ¦†çš„æ„›å¿ƒè¾²å ´</h2>
        <div><button class="plantSeed">ğŸŒ± ä¸‹ç¨®å­</button>
        <button class="water" disabled>ğŸ’§ æ¾†æ°´</button>
        <button class="dust" disabled>ğŸ§¼ é™¤å¡µ</button>
        <button class="clear">ğŸ—‘ æ¸…é™¤ç´€éŒ„</button></div>
        <div class="status"></div><div class="log"></div>
      </div></td>
      <td><div class="farm" id="farm-coffee"><h2>å’–å•¡æ£ çš„æ„›å¿ƒè¾²å ´</h2>
        <div><button class="plantSeed">ğŸŒ± ä¸‹ç¨®å­</button>
        <button class="water" disabled>ğŸ’§ æ¾†æ°´</button>
        <button class="dust" disabled>ğŸ§¼ é™¤å¡µ</button>
        <button class="clear">ğŸ—‘ æ¸…é™¤ç´€éŒ„</button></div>
        <div class="status"></div><div class="log"></div>
      </div></td>
    </tr>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5VJ1cb_ihQSlfzQm8vLa-0exU5-YTrc0",
      authDomain: "coffeesugar-planting.firebaseapp.com",
      projectId: "coffeesugar-planting"
    };
    firebase.initializeApp(firebaseConfig);
    // ç¢ºä¿åªå®šç¾©ä¸€æ¬¡ db
    if (typeof db === 'undefined') {
      var db = firebase.firestore();
    }
    const stageLimits = [1, 1, 5, 9];

    function setupFarm(farmId, docId) {
      const container = document.getElementById(farmId);
      function getEl(className) {
        return container.querySelector(`.${className}`);
      }

      const plantSeed = getEl('plantSeed');
      const water = getEl('water');
      const dust = getEl('dust');
      const clear = getEl('clear');
      const status = getEl('status');
      const logDiv = getEl('log');

      let state = {
        seeded: false,
        stage: 0,
        progress: 0,
        log: [],
        nextAction: 'water'
      };

      const ref = db.collection('heart_planting').doc(docId);

      function updateUI() {
        plantSeed.disabled = state.seeded;
        water.disabled = !(state.seeded && state.nextAction === 'water');
        dust.disabled = !(state.seeded && state.nextAction === 'dust');

        status.innerText = state.seeded
          ? `ç›®å‰ç‚ºç¬¬ ${state.stage + 1} éšæ®µï¼Œç¬¬ ${Math.floor(state.progress / 2) + 1} æ¬¡ ${state.nextAction === 'water' ? 'æ¾†æ°´' : 'é™¤å¡µ'}`
          : 'è«‹å…ˆä¸‹ç¨®å­';

        const htmlParts = [];
        for (let stage = 0; stage < 4; stage++) {
          const limit = stageLimits[stage];
          htmlParts.push(`<h4>ç¬¬ ${stage + 1} éšæ®µ</h4>`);
          htmlParts.push('<table><thead><tr><th style="width: 60px;">æ¬¡æ•¸</th><th>æ¾†æ°´æ™‚é–“</th><th>é™¤å¡µæ™‚é–“</th></tr></thead><tbody>');
          for (let i = 0; i < limit; i++) {
  const w = state.log.find(e => e.stage === stage && e.action === 'æ¾†æ°´' && e.count === i + 1);
  const d = state.log.find(e => e.stage === stage && e.action === 'é™¤å¡µ' && e.count === i + 1);
  const wTime = w ? w.time : '<span style="color:#aaa;font-style:italic">N/A</span>';
  const dTime = d ? d.time : '<span style="color:#aaa;font-style:italic">N/A</span>';
  htmlParts.push(`<tr><td>ç¬¬ ${i + 1} æ¬¡</td><td>${wTime}</td><td>${dTime}</td></tr>`);
}
htmlParts.push('</tbody></table>');
        }
        logDiv.innerHTML = htmlParts.join('');
      }

      function logAction(action) {
        const now = new Date().toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
        state.log.push({
          action,
          stage: state.stage,
          count: Math.floor(state.progress / 2) + 1,
          time: now
        });
      }

      async function saveState() {
        await ref.set(state);
      }

      plantSeed.onclick = async () => {
        console.log('ğŸŒ± ä¸‹ç¨®å­æŒ‰éˆ•è¢«é»æ“Š');
        if (state.seeded) return;
        state = { seeded: true, stage: 0, progress: 0, log: [], nextAction: 'water' };
        logAction('ä¸‹ç¨®å­');
        await saveState(); updateUI();
      };
      water.onclick = async () => {
        console.log('ğŸ’§ æ¾†æ°´æŒ‰éˆ•è¢«é»æ“Š');
        if (state.nextAction !== 'water') return;
        logAction('æ¾†æ°´');
        state.progress++; state.nextAction = 'dust';
        await checkProgress();
      };
      dust.onclick = async () => {
        console.log('ğŸ§¼ é™¤å¡µæŒ‰éˆ•è¢«é»æ“Š');
        if (state.nextAction !== 'dust') return;
        logAction('é™¤å¡µ');
        state.progress++; state.nextAction = 'water';
        await checkProgress();
      };
      async function checkProgress() {
        if (state.progress >= stageLimits[state.stage] * 2) {
          if (state.stage < stageLimits.length - 1) {
            state.stage++; state.progress = 0;
          } else {
            state.nextAction = 'done';
          }
        }
        await saveState(); updateUI();
      }

      clear.onclick = async () => {
        await ref.delete();
        state = { seeded: false, stage: 0, progress: 0, log: [], nextAction: 'water' };
        updateUI();
      };

      async function init() {
        const doc = await ref.get();
        if (doc.exists) state = doc.data();
        updateUI();
      }
      init();
    }

    setupFarm('farm-yuyu', 'record_yuyu');
    setupFarm('farm-coffee', 'record_coffee');
  </script>
</body>
</html>
