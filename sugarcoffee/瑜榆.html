<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC5VJ1cb_ihQSlfzQm8vLa-0exU5-YTrc0",
    authDomain: "coffeesugar-planting.firebaseapp.com",
    projectId: "coffeesugar-planting",
    storageBucket: "coffeesugar-planting.appspot.com",
    messagingSenderId: "1049930202443",
    appId: "1:1049930202443:web:201becb988df55e12d7cce",
    measurementId: "G-HDE40D5FSP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentRole = "瑜榆";
  const historyCollection = collection(db, "sharedPlantingHistory");

  const stageDefs = [
    { watering: 0, dusting: 0 },
    { watering: 1, dusting: 1 },
    { watering: 1, dusting: 1 },
    { watering: 5, dusting: 5 },
    { watering: 9, dusting: 9 },
  ];

  function getUserId() {
    return "user-id";  // 假設這是登入的使用者ID
  }

  function getStageAndProgress(records) {
    records = [...records].sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds);
    if (!records.some(r => r.action === '下種子')) return { stage: 0 };

    let stage = 1;
    let remaining = [...records].reverse();
    for (let i = 1; i < stageDefs.length; i++) {
      const req = stageDefs[i];
      let wCount = 0, dCount = 0;
      for (let rec of remaining) {
        if (rec.action === '澆水' && wCount < req.watering) {
          wCount++;
        } else if (rec.action === '除塵' && wCount >= req.watering && dCount < req.dusting) {
          dCount++;
        } else {
          break;
        }
      }
      if (wCount === req.watering && dCount === req.dusting) {
        stage = i;
        remaining = remaining.slice(wCount + dCount);
      } else {
        return { stage, wProgress: wCount + 1, dProgress: dCount + 1 };
      }
    }
    return { stage };
  }

  window.addPlantingRecord = async function(action) {
    if (action === '澆水' || action === '除塵') {
      const records = await getUserRecords();
      const { stage, wProgress, dProgress } = getStageAndProgress(records);
      
      if (action === '澆水') {
        if (wProgress >= stageDefs[stage].watering) return alert("澆水次數已達上限，請進行除塵。");
        await addDoc(historyCollection, {
          action,
          user: getUserId(),
          role: currentRole,
          timestamp: serverTimestamp()
        });
      } else if (action === '除塵') {
        if (wProgress < stageDefs[stage].watering) return alert("請先完成澆水後才能除塵。");
        if (dProgress >= stageDefs[stage].dusting) return alert("除塵次數已達上限，請進行下一階段。");
        await addDoc(historyCollection, {
          action,
          user: getUserId(),
          role: currentRole,
          timestamp: serverTimestamp()
        });
      }

      loadHistory();
    }
  };

  async function getUserRecords() {
    const q = query(historyCollection, orderBy("timestamp", "asc"));
    const querySnapshot = await getDocs(q);
    return querySnapshot.docs.map(doc => doc.data()).filter(d => d.user === getUserId() && d.role === currentRole);
  }

  window.loadHistory = async function() {
    const yuyuList = document.getElementById("yuyu-history");
    const coffeeList = document.getElementById("coffee-history");
    yuyuList.innerHTML = "";
    coffeeList.innerHTML = "";

    try {
      const q = query(historyCollection, orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.user || '匿名'}：${data.action} - ${data.timestamp?.toDate?.().toLocaleString() || '尚未同步'}`;
        if (data.role === "瑜榆") {
          yuyuList.appendChild(li);
        } else if (data.role === "咖啡棠") {
          coffeeList.appendChild(li);
        }
      });
    } catch (err) {
      alert("⚠️ 無法讀取紀錄，請檢查 Firestore 權限設定。");
    }
  };
</script>
