<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸµ æ­Œæ›²ç®¡ç†ç³»çµ±</title>
  <style>
    body {
      margin: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      background: #222;
      color: #eee;
      display: flex;
      height: 100vh;
    }
    .left, .right {
      padding: 20px;
      overflow: auto;
      flex-shrink: 0;
    }
    .left {
      flex: 2;
      border-right: 2px solid #444;
    }
    .right {
      flex: 1;
      background: #333;
    }
    h2 {
      margin-top: 0;
      color: #ffcc00;
    }
    input, select {
      padding: 6px;
      margin: 4px;
      border: none;
      border-radius: 5px;
      background: #444;
      color: #fff;
    }
    button {
      padding: 8px 14px;
      margin: 4px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #ffcc00;
      color: #000;
      font-weight: bold;
    }
    button:hover { background: #ffaa00; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #555;
    }
    th {
      cursor: pointer;
      color: #ffcc00;
    }
    tr:hover { background: #444; }
    .filters {
      margin-bottom: 10px;
    }
    .pagination { text-align: center; margin-top: 10px; }
    .pagination button {
      background: #666;
      color: #fff;
    }
    .pagination button:disabled {
      background: #ffcc00;
      color: #000;
    }
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        height: auto;
      }
      .left, .right {
        flex: 1;
        width: 100%;
        border-right: none;
        border-bottom: 2px solid #444;
      }
      .filters {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .filters input, .filters select {
        flex: 1 1 auto;
        min-width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="left">
    <h2>ğŸ“‹ GGLæ­Œæ›²æ¸…å–®</h2>
    <div class="filters">
      <input type="text" id="search" placeholder="ğŸ” é—œéµå­—æœå°‹...">
      <select id="filterLang">
        <option value="">å…¨éƒ¨èªè¨€</option>
        <option>ä¸­æ–‡</option>
        <option>è‹±æ–‡</option>
        <option>æ—¥æ–‡</option>
        <option>éŸ“æ–‡</option>
        <option>è¶Šå—</option>
        <option>ç²µèª</option>
        <option>å°èª</option>
      </select>
      <select id="filterStyle">
        <option value="">å…¨éƒ¨å‹æ…‹</option>
        <option>æƒ…æ­Œ</option>
        <option>æ‚²å‚·</option>
        <option>å—¨æ­Œ</option>
        <option>RAP</option>
        <option>æŠ’æƒ…</option>
      </select>
      <select id="filterBpm">
        <option value="">å…¨éƒ¨é€Ÿåº¦</option>
        <option value="61-70">61â€“70</option>
        <option value="71-80">71â€“80</option>
        <option value="81-90">81â€“90</option>
        <option value="91-100">91â€“100</option>
        <option value="101-110">101â€“110</option>
        <option value="111-120">111â€“120</option>
        <option value="121-130">121â€“130</option>
        <option value="131-140">131â€“140</option>
        <option value="141-150">141â€“150</option>
        <option value="151-160">151â€“160</option>
        <option value="161-170">161â€“170</option>
        <option value="171-180">171â€“180</option>
        <option value="181-190">181â€“190</option>
        <option value="191-200">191â€“200</option>
        <option value="201-250">201â€“250</option>
      </select>
      <select id="filterRank">
        <option value="">å…¨éƒ¨æ¦œå–®</option>
        <option>ç¾å¥³å¯¶è²</option>
        <option>å‘†å‘†å¯¶è²</option>
        <option>å…©è€…éƒ½æœ‰</option>
      </select>
    </div>
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('name')">æ­Œå</th>
          <th onclick="sortBy('bpm')">é€Ÿåº¦</th>
          <th onclick="sortBy('lang')">èªè¨€</th>
          <th onclick="sortBy('style')">å‹æ…‹</th>
          <th onclick="sortBy('rank_type')">æœ‰ç„¡ä¸Šæ¦œ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="songTable"></tbody>
    </table>
    <div class="pagination" id="pagination"></div>
  </div>

  <div class="right">
    <h2>âœï¸ æ–°å¢ / ç·¨è¼¯æ­Œæ›²</h2>
    <input type="hidden" id="songId">
    <p><input id="songName" placeholder="æ­Œå"></p>
    <p><input id="songBpm" type="number" placeholder="BPM"></p>
    <p>
      <select id="songLang">
        <option>ä¸­æ–‡</option>
        <option>è‹±æ–‡</option>
        <option>æ—¥æ–‡</option>
        <option>éŸ“æ–‡</option>
        <option>è¶Šå—</option>
        <option>ç²µèª</option>
        <option>å°èª</option>
      </select>
    </p>
    <p>
      <select id="songStyle">
        <option>æƒ…æ­Œ</option>
        <option>æ‚²å‚·</option>
        <option>å—¨æ­Œ</option>
        <option>RAP</option>
        <option>æŠ’æƒ…</option>
      </select>
    </p>
    <p>
      <select id="songRank">
        <option>ç¾å¥³å¯¶è²</option>
        <option>å‘†å‘†å¯¶è²</option>
        <option>å…©è€…éƒ½æœ‰</option>
        <option>æ‘ƒé¾œ</option>
      </select>
    </p>
    <button id="saveSongBtn">ğŸ’¾ å„²å­˜</button>
    <button id="clearFormBtn">ğŸ§¹ æ¸…é™¤</button>

    <hr style="border-color:#555; margin: 20px 0;">
    <h2>ğŸ“¤ CSV åŒ¯å…¥</h2>
    <p>
      <input type="file" id="csvFile" accept=".csv" style="padding: 10px;">
    </p>
    <button id="importCsvBtn">ğŸš€ åŒ¯å…¥æ­Œæ›²</button>
    <p id="importStatus" style="font-size:12px;"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let songs = [];
    let currentPage = 1;
    const pageSize = 10;
    let sortKey = "";
    let sortAsc = true;

    // â­ ä¿®æ­£ï¼š Supabase è¨­å®šèˆ‡æ–°è¡¨æ ¼åç¨±
    const SUPABASE_URL = 'https://qcvkwglzltebvajvyakm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjdmt3Z2x6bHRlYnZhanZ5YWttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzUwMjcsImV4cCI6MjA3MTYxMTAyN30.K1teLYiXQDquCcFKXX3ugdNfJCWqnik4XqQVQykr-go';
    const TABLE_NAME = 'ranked_songs'; // â­ æ–°è¡¨æ ¼åç¨±

    const { createClient } = supabase;
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadSongs() {
      const { data, error } = await supabase.from(TABLE_NAME).select('*');
      if (error) {
        console.error('è¼‰å…¥æ­Œæ›²å¤±æ•—:', error);
        alert('è¼‰å…¥æ­Œæ›²å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Supabase è¨­å®šï¼');
      } else {
        songs = data || [];
        render();
      }
    }

    // å„²å­˜æ­Œæ›²
    async function saveSong() {
        const songId = document.getElementById("songId").value;
        const songName = document.getElementById("songName").value.trim();
        const songBpm = parseInt(document.getElementById("songBpm").value) || 0;
        const songLang = document.getElementById("songLang").value;
        const songStyle = document.getElementById("songStyle").value;
        const songRank = document.getElementById("songRank").value; // â­ æ–°å¢ï¼šå–å¾—æ¦œå–®é¡å‹

        if (!songName) {
            return alert("è«‹è¼¸å…¥æ­Œå");
        }

        const newSong = { 
            name: songName, 
            bpm: songBpm, 
            lang: songLang, 
            style: songStyle,
            rank_type: songRank // â­ æ–°å¢ï¼šåŠ å…¥æ¦œå–®é¡å‹
        };
        let result;

        if (songId) {
            // ç·¨è¼¯æ­Œæ›²
            const { data: existingSongs } = await supabase.from(TABLE_NAME).select('id').eq('name', songName);
            
            if (existingSongs.length > 0 && existingSongs[0].id !== songId) {
                alert("é€™é¦–æ­Œåå·²ç¶“å­˜åœ¨äº†ï¼Œè«‹æ›´æ›ï¼");
                return;
            }
            result = await supabase.from(TABLE_NAME).update(newSong).eq('id', songId);
        } else {
            // æ–°å¢æ­Œæ›²
            const { data: existingSongs } = await supabase.from(TABLE_NAME).select('id').eq('name', songName);

            if (existingSongs.length > 0) {
                alert("é€™é¦–æ­Œå·²ç¶“å­˜åœ¨äº†ï¼Œè«‹å‹¿é‡è¤‡è¼¸å…¥ï¼");
                return;
            }
            result = await supabase.from(TABLE_NAME).insert(newSong);
        }

        if (result.error) {
            alert('å„²å­˜å¤±æ•—ï¼š' + result.error.message);
        } else {
            clearForm();
            loadSongs();
        }
    }
    
    // åŒ¯å…¥ CSV
    async function importCsv() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      if (!file) return alert('è«‹é¸æ“‡ä¸€å€‹ CSV æª”æ¡ˆï¼');

      const importStatus = document.getElementById('importStatus');
      importStatus.textContent = "æ­£åœ¨è®€å–æª”æ¡ˆ...";

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results) {
          const dataToInsert = results.data.map(row => ({
            name: row.name,
            bpm: parseInt(row.bpm) || 0,
            lang: row.lang,
            style: row.style,
            rank_type: row.rank_type || '' // â­ æ–°å¢ï¼šåŒ¯å…¥æ¦œå–®é¡å‹
          }));

          if (dataToInsert.length === 0) {
            alert('CSV æª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ­Œæ›²è³‡æ–™ã€‚');
            importStatus.textContent = "";
            return;
          }

          importStatus.textContent = `æ‰¾åˆ° ${dataToInsert.length} ç­†è³‡æ–™ï¼Œé–‹å§‹åŒ¯å…¥...`;
          for (const [index, row] of dataToInsert.entries()) {
            const { error } = await supabase.from(TABLE_NAME).insert([row]);
            if (error) {
              importStatus.textContent = `åŒ¯å…¥å¤±æ•—æ–¼ç¬¬ ${index + 1} ç­†ï¼š${error.message}`;
              console.error('åŒ¯å…¥éŒ¯èª¤:', error);
              return;
            }
            importStatus.textContent = `åŒ¯å…¥é€²åº¦ï¼š${index + 1} / ${dataToInsert.length} ç­†...`;
          }

          importStatus.textContent = `æˆåŠŸåŒ¯å…¥ ${dataToInsert.length} ç­†æ­Œæ›²ï¼`;
          loadSongs();
          fileInput.value = '';
        }
      });
    }

    function editSong(id) {
      const song = songs.find(s => s.id === id);
      if (!song) return;
      document.getElementById("songId").value = song.id;
      document.getElementById("songName").value = song.name;
      document.getElementById("songBpm").value = song.bpm;
      document.getElementById("songLang").value = song.lang;
      document.getElementById("songStyle").value = song.style;
      document.getElementById("songRank").value = song.rank_type || 'ç¾å¥³å¯¶è²'; // â­ æ–°å¢ï¼šè¨­å®šæ¦œå–®é¡å‹
    }

    async function deleteSong(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
      const { error } = await supabase.from(TABLE_NAME).delete().eq('id', id);
      if (error) alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
      else loadSongs();
    }

    function clearForm() {
      document.getElementById("songId").value = "";
      document.getElementById("songName").value = "";
      document.getElementById("songBpm").value = "";
      document.getElementById("songLang").value = "ä¸­æ–‡";
      document.getElementById("songStyle").value = "æƒ…æ­Œ";
      document.getElementById("songRank").value = "ç¾å¥³å¯¶è²"; // â­ æ–°å¢ï¼šæ¸…é™¤æ¦œå–®é¡å‹
    }

    // ğŸ” ä¿®æ­£ç‰ˆç¯©é¸é‚è¼¯
    function render() {
      const search = document.getElementById("search").value.toLowerCase().trim();
      const filterLang = document.getElementById("filterLang").value.toLowerCase().trim();
      const filterStyle = document.getElementById("filterStyle").value.toLowerCase().trim();
      const filterBpm = document.getElementById("filterBpm").value;
      const filterRank = document.getElementById("filterRank").value.toLowerCase().trim(); // â­ æ–°å¢ï¼šå–å¾—æ¦œå–®ç¯©é¸å€¼

      let filtered = songs.filter(s => {
        let ok = true;
        const name = (s.name || "").toLowerCase().trim();
        const lang = (s.lang || "").toLowerCase().trim();
        const style = (s.style || "").toLowerCase().trim();
        const bpm = Number(s.bpm) || 0;
        const rankType = (s.rank_type || "").toLowerCase().trim(); // â­ æ–°å¢ï¼šå–å¾—æ­Œæ›²çš„æ¦œå–®å€¼

        if (search && !(name.includes(search) || lang.includes(search) || style.includes(search))) ok = false;
        if (filterLang && lang !== filterLang) ok = false;
        if (filterStyle && style !== filterStyle) ok = false;
        
        if (filterBpm) {
          const [min, max] = filterBpm.split("â€“").map(Number);
          if (!(bpm >= min && bpm <= max)) ok = false;
        }

        if (filterRank && rankType !== filterRank) ok = false; // â­ æ–°å¢ï¼šæ¦œå–®ç¯©é¸é‚è¼¯

        return ok;
      });

      if (sortKey) {
        filtered.sort((a, b) => {
          if (a[sortKey] < b[sortKey]) return sortAsc ? -1 : 1;
          if (a[sortKey] > b[sortKey]) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      const totalPages = Math.ceil(filtered.length / pageSize);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      const start = (currentPage - 1) * pageSize;
      const pageData = filtered.slice(start, start + pageSize);

      const tbody = document.getElementById("songTable");
      tbody.innerHTML = pageData.length
        ? pageData.map(s => `
          <tr>
            <td>${s.name}</td>
            <td>${s.bpm}</td>
            <td>${s.lang}</td>
            <td>${s.style}</td>
            <td>${s.rank_type}</td> <td>
              <button onclick="editSong('${s.id}')">âœï¸ ç·¨è¼¯</button>
              <button onclick="deleteSong('${s.id}')">ğŸ—‘ åˆªé™¤</button>
            </td>
          </tr>`).join("")
        : `<tr><td colspan="6">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„æ­Œæ›²ã€‚</td></tr>`;

      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `<button onclick="gotoPage(${i})" ${i === currentPage ? "disabled" : ""}>${i}</button>`;
      }
    }

    function sortBy(key) {
      if (sortKey === key) sortAsc = !sortAsc;
      else { sortKey = key; sortAsc = true; }
      render();
    }

    function gotoPage(page) {
      currentPage = page;
      render();
    }

    document.getElementById("saveSongBtn").onclick = saveSong;
    document.getElementById("clearFormBtn").onclick = clearForm;
    document.getElementById("importCsvBtn").onclick = importCsv;

    document.getElementById("search").addEventListener("input", render);
    document.getElementById("filterLang").addEventListener("change", render);
    document.getElementById("filterStyle").addEventListener("change", render);
    document.getElementById("filterBpm").addEventListener("change", render);
    document.getElementById("filterRank").addEventListener("change", render); // â­ æ–°å¢ï¼šç¶å®šæ¦œå–®ç¯©é¸

    window.onload = loadSongs;
  </script>
</body>

</html>




