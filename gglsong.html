<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>🎵 GGL 歌曲管理</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #222; color: #eee; padding: 20px; }
    h2 { color: #ffcc00; }
    input, select { padding: 6px; margin: 4px; border: none; border-radius: 5px; background: #444; color: #fff; }
    button { padding: 8px 14px; margin: 4px; border: none; border-radius: 5px; cursor: pointer; background: #ffcc00; color: #000; font-weight: bold; }
    button:hover { background: #ffaa00; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; text-align: center; border-bottom: 1px solid #555; }
    th { color: #ffcc00; }
    tr:hover { background: #444; }
  </style>
</head>
<body>
  <h2>📋 GGL 歌曲清單</h2>
  <table>
    <thead>
      <tr>
        <th>歌名</th>
        <th>BPM</th>
        <th>語言</th>
        <th>型態</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="songTable"></tbody>
  </table>

  <h2>✍️ 新增 / 編輯歌曲</h2>
  <input type="hidden" id="songId">
  <p><input id="songName" placeholder="歌名"></p>
  <p><input id="songBpm" type="number" placeholder="BPM"></p>
  <p>
    <select id="songLang">
      <option>中文</option>
      <option>英文</option>
      <option>日文</option>
      <option>韓文</option>
    </select>
  </p>
  <p>
    <select id="songStyle">
      <option>情歌</option>
      <option>悲傷</option>
      <option>嗨歌</option>
      <option>RAP</option>
    </select>
  </p>
  <button id="saveSongBtn">💾 儲存</button>
  <button id="clearFormBtn">🧹 清除</button>

  <!-- 載入 Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let songs = [];

    // ⭐ Supabase 設定
    const SUPABASE_URL = 'https://qcvkwglzltebvajvyakm.supabase.co';
    const SUPABASE_KEY = '你的 anon key'; // ⚠️ 記得換掉
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 🚀 載入歌曲
    async function loadSongs() {
      const { data, error } = await supabaseClient.from('ranked_songs').select('*');
      if (error) {
        console.error('載入歌曲失敗:', error);
        alert('載入歌曲失敗，請檢查 Supabase 設定！');
      } else {
        songs = data || [];
        render();
      }
    }

    // 儲存歌曲
    async function saveSong() {
      const songId = document.getElementById("songId").value;
      const songName = document.getElementById("songName").value.trim();
      const songBpm = parseInt(document.getElementById("songBpm").value) || 0;
      const songLang = document.getElementById("songLang").value;
      const songStyle = document.getElementById("songStyle").value;
      if (!songName) return alert("請輸入歌名");

      const newSong = { name: songName, bpm: songBpm, lang: songLang, style: songStyle };

      let result;
      if (songId) {
        result = await supabaseClient.from('ranked_songs').update(newSong).eq('id', songId);
      } else {
        result = await supabaseClient.from('ranked_songs').insert(newSong);
      }

      if (result.error) alert('儲存失敗：' + result.error.message);
      else { clearForm(); loadSongs(); }
    }

    function editSong(id) {
      const song = songs.find(s => s.id === id);
      if (!song) return;
      document.getElementById("songId").value = song.id;
      document.getElementById("songName").value = song.name;
      document.getElementById("songBpm").value = song.bpm;
      document.getElementById("songLang").value = song.lang;
      document.getElementById("songStyle").value = song.style;
    }

    async function deleteSong(id) {
      if (!confirm("確定要刪除嗎？")) return;
      const { error } = await supabaseClient.from('ranked_songs').delete().eq('id', id);
      if (error) alert('刪除失敗：' + error.message);
      else loadSongs();
    }

    function clearForm() {
      document.getElementById("songId").value = "";
      document.getElementById("songName").value = "";
      document.getElementById("songBpm").value = "";
      document.getElementById("songLang").value = "中文";
      document.getElementById("songStyle").value = "情歌";
    }

    function render() {
      const tbody = document.getElementById("songTable");
      tbody.innerHTML = songs.length
        ? songs.map(s => `
          <tr>
            <td>${s.name}</td>
            <td>${s.bpm}</td>
            <td>${s.lang}</td>
            <td>${s.style}</td>
            <td>
              <button onclick="editSong('${s.id}')">✏️ 編輯</button>
              <button onclick="deleteSong('${s.id}')">🗑 刪除</button>
            </td>
          </tr>`).join("")
        : `<tr><td colspan="5">尚無歌曲資料。</td></tr>`;
    }

    document.getElementById("saveSongBtn").onclick = saveSong;
    document.getElementById("clearFormBtn").onclick = clearForm;

    window.onload = loadSongs;
  </script>
</body>
</html>
